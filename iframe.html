<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script>
      async function loadScriptAsync(src) {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = src;
          script.type = "text/javascript";
          script.async = true;

          // Resolve the promise when the script is loaded
          script.onload = () => {
            console.log(`Script loaded: ${src}`);
            resolve();
          };

          // Reject the promise if there's an error loading the script
          script.onerror = () => {
            console.error(`Failed to load script: ${src}`);
            reject(new Error(`Failed to load script: ${src}`));
          };

          // Append the script to the document head
          document.head.appendChild(script);
        });
      }

      class PharmacyOrder {
        _privateKey;
        _iframe;

        constructor(elementSelector, session, privatePEMKey) {
          this._privateKey = this._importPrivateKey(privatePEMKey);

          this._iframe = document.createElement("iframe");
          this._iframe.frameBorder = 0;
          this._iframe.width = "100%";
          this._iframe.src = `http://localhost:5173?session=${session}`;

          window.addEventListener(
            "message",
            this.handleMessage.bind(this),
            false
          );

          this._init(elementSelector);
        }

        async _init(elementSelector) {
          await loadScriptAsync(
            "https://cdn.jsdelivr.net/npm/@iframe-resizer/parent@5.3.2"
          );

          iframeResize({ license: "GPLv3", waitForLoad: true }, this._iframe);

          let target = document.querySelector(elementSelector);
          if (!target) {
            throw new Error(
              "Element not found to mount the pharmacy order widget."
            );
          }

          target.appendChild(this._iframe);
        }

        async _importPrivateKey(pemKey) {
          // Remove the PEM header, footer, and line breaks
          const pemContents = pemKey
            .replace(/-----BEGIN PRIVATE KEY-----/, "")
            .replace(/-----END PRIVATE KEY-----/, "")
            .replace(/\n/g, "")
            .replace(/\r/g, "");

          // Decode Base64 to ArrayBuffer
          const binaryKey = atob(pemContents);
          const binaryKeyBuffer = new Uint8Array(binaryKey.length);
          for (let i = 0; i < binaryKey.length; i++) {
            binaryKeyBuffer[i] = binaryKey.charCodeAt(i);
          }

          // Import the private key into Web Crypto
          const privateKey = await crypto.subtle.importKey(
            "pkcs8", // Format of the private key
            binaryKeyBuffer.buffer, // The ArrayBuffer containing the key
            {
              name: "RSASSA-PKCS1-v1_5", // Algorithm
              hash: { name: "SHA-256" }, // Hash function
            },
            true, // Whether the key is extractable
            ["sign"] // Usages
          );

          return privateKey;
        }

        async handleMessage(event) {
          if (!this._privateKey) {
            console.error("Private key not initialized.");
            return;
          }

          const { type, data } = event.data;

          if (type === "SIGN_REQUEST" && data) {
            try {
              const signedResponse = await this.sign(data);
              event.source.postMessage(
                {
                  type: "SIGN_RESPONSE",
                  data: signedResponse,
                },
                event.origin
              );
            } catch (error) {
              console.error("Error signing data:", error);
              event.source.postMessage(
                {
                  type: "SIGN_ERROR",
                  error: error.message,
                },
                event.origin
              );
            }
          }
        }

        async sign(data) {
          if (!this._privateKey) {
            throw new Error("Private key not initialized.");
          }

          const encoder = new TextEncoder();
          const signature = await crypto.subtle.sign(
            {
              name: "RSASSA-PKCS1-v1_5",
            },
            this._privateKey,
            encoder.encode(data)
          );

          return {
            signature: btoa(String.fromCharCode(...new Uint8Array(signature))),
            fingerprint: await this.hash(data),
          };
        }

        async hash(string) {
          const utf8 = new TextEncoder().encode(string);
          const hashBuffer = await crypto.subtle.digest("SHA-256", utf8);
          const hashArray = Array.from(new Uint8Array(hashBuffer));
          const hashHex = hashArray
            .map((bytes) => bytes.toString(16).padStart(2, "0"))
            .join("");
          return hashHex;
        }
      }

      document.addEventListener("DOMContentLoaded", function (event) {
        let privatePEMKey = `-----BEGIN PRIVATE KEY-----
      MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC6fY20I4ZnRMZQ
      rgvNjc0JtAim3nosUQmEE8dotmiE9Y3vSAs+u3G6/mHLk4ZOvicstnvkGmmkabfs
      FOYJsmtg6xQiaKbADYHmK8WGSoJGYTgS8cDmKhmdLgw1gK4/f12PuSHPNh687yAm
      3iyYvwLPF9EecKOhwnSU20HOMjtVqOtE5Dh3x1ZYqPkfLWqzj3w844Q9B10HpuNQ
      juVS3qkST3Inp7O9ub1bCxwuIn+SiG3NssKRfLqXNLdy8Ghtfzepy0lGO4Jt1hZm
      MXqKRAadryOfStJ2A9XQS1HT0/KCo0tHMC7Mv2H+PkOwwmHSJZKXcepy2bnLIYGf
      4qHPA4M1AgMBAAECggEAHpMD/uMOH3Mikkqei8IyOeOGwZja7dYRWdKGUFALfbTm
      YrLsiQnhIPegn+gdTl6VfJqkYCbGaBqe+TkJ59AVE6wmvmdq4zSztcE6XoRrrE83
      CsAQ0ItZbLAGd2UT7Dwc4jnHZbnpOy93FXg6VoaGVt6APd3YreX8CAWUWdJZcPb6
      /VvqQMkktLGid4cjwxqfAKAcNeJXtSEp+vlVH+F3k4kY/vtU8C0XvIJx24JmDsJy
      RF7+5BMfZao70+e+HCDpkevXVRPd0xNbypVazJ279caRck6RkBYEhuOMxWTdYM3m
      sdSpPueN93Lnfua6QMPtBMsN1c4LqXC9sXxOpIdjpwKBgQD3UvqcKVPV1MYpeO/6
      9/R89jrMTlKxV9auXVv6PALCJMdQsI6PQpU9XWFDMJZkJb0Ifuz5STwtH5+TneKM
      I+rRw/HDfmM9r79FfyHJACuvQK/e16RFOneAAri5t93sUsE+EC1aWmnAGiBXbqJN
      DgqMyAIplX67VCnCPAL50TpNMwKBgQDBCEaQyyvtsMEhCR2uY8j6pdqOBbuBrpPR
      HXucCn202GHFFuFkJ/0U6etQKHCuf/+P/BPk3wkcHoqJmjCiZ6XSdzQFKDqNv0m5
      R8Sk2ksHkbxS5ly0pjdF7NSpBvFxbKs0MF3zfZLC7Qr4czOsqGpSPUX4nwdyy9Ou
      /gprzGrd9wKBgGLBvpJGqlQzDyGWSfUjt3uCcr4L9FceJPohC04jUlKljvT4WyR3
      SNJlDCZhK1w3+YB/9i4ggSfffb/bBpBA803peQs/127VU4HzntD9AXSMVu2bm9uM
      2hTCgXKfKb1o2gLnQMTYX2u2wv1GjwZHugy2/K4QJLe2hqopfmK0mhwjAoGBALqO
      7/xCkAsh2BXAhLIleHleT9MRET5tZiklsHCH5yQgOKXNzjoJN9y9kxIec4EC7hDP
      VL7PHDPUBJqmrbhYKfg2As21KpoSNQNfrFqTKw5+uB76ysBBIIxxLrrJnhG8L965
      nCOWyn+frwmd9WQ6RL+EvpphwEYfXk/y8EltAB/TAoGBAOhReU0+WLMeLAfok/yl
      0Vjzwye4/Aj+MnWvDJf2EmT7eP4uW5WTkh3KJN4eaurkyBrPIT0xT2kSwVY1uDei
      ZtMLENbhC57DK5sLs9R88MdcPrZecHvkfFiVvlIU0RxYXoN+Dx4M3/3wxNyD2EdZ
      ZW2QGU2qkCxID9F4pxD24s3U
      -----END PRIVATE KEY-----`;

        new PharmacyOrder("#order", "super-secret-key", privatePEMKey);
      });
    </script>
  </head>
  <body>
    <div style="max-width: 800px; margin: 0 auto" id="order"></div>
  </body>
</html>
